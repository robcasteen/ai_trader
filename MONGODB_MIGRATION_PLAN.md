# MongoDB Migration Plan
**Date:** 2025-10-25
**Status:** Ready to Execute

---

## MongoDB Setup Options

### Option 1: MongoDB Atlas (Recommended for Quick Start)
**Pros:**
- Free tier (512MB storage)
- No local installation
- Cloud-hosted, accessible anywhere
- Built-in monitoring and backups

**Setup:**
1. Go to https://www.mongodb.com/cloud/atlas/register
2. Create free cluster
3. Get connection string
4. Add to `.env`: `MONGODB_URI=mongodb+srv://...`

### Option 2: Local MongoDB Installation
**Pros:**
- Full control
- No internet dependency
- Unlimited storage

**Setup (Ubuntu):**
```bash
wget -qO - https://www.mongodb.org/static/pgp/server-7.0.asc | sudo apt-key add -
echo "deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/7.0 multiverse" | sudo tee /etc/apt/sources.list.d/mongodb-org-7.0.list
sudo apt-get update
sudo apt-get install -y mongodb-org
sudo systemctl start mongod
sudo systemctl enable mongod
```

### Option 3: TinyDB (Lightweight Alternative for Testing)
**Pros:**
- Pure Python, no external dependencies
- Same query interface as MongoDB
- Perfect for development/testing
- Easy migration to real MongoDB later

**Setup:**
```bash
pip install tinydb
```

---

## Database Schema Design

### Database: `kraken_ai_bot`

### Collections

#### 1. `signals`
**Purpose:** Every signal generated by strategies

```javascript
{
  _id: ObjectId,
  timestamp: ISODate,
  symbol: String,              // "BTCUSD"
  price: Decimal128,
  final_signal: String,        // "BUY", "SELL", "HOLD"
  final_confidence: Decimal128,
  aggregation_method: String,  // "weighted_average", "consensus", etc

  // Strategy breakdown
  strategies: {
    "sentiment": {
      signal: String,
      confidence: Decimal128,
      reason: String,
      weight: Decimal128,
      enabled: Boolean
    },
    "technical": { ... },
    "volume": { ... }
  },

  // Provenance & Testing
  test_mode: Boolean,          // *** NEW: Is this a test signal?
  bot_version: String,         // *** NEW: "1.0.0"
  strategy_version: String,    // *** NEW: Hash of strategy configs

  // Metadata
  metadata: Object,            // Additional context
  created_at: ISODate,

  // Indexes
  indexes: [
    { timestamp: -1 },
    { symbol: 1, timestamp: -1 },
    { test_mode: 1 },
    { final_signal: 1, timestamp: -1 }
  ]
}
```

#### 2. `trades`
**Purpose:** Executed trades

```javascript
{
  _id: ObjectId,
  timestamp: ISODate,
  action: String,              // "buy", "sell"
  symbol: String,
  price: Decimal128,
  amount: Decimal128,

  // Financial
  gross_value: Decimal128,
  fee: Decimal128,
  net_value: Decimal128,

  // Attribution
  signal_id: ObjectId,         // *** NEW: Reference to signal that triggered this
  strategies_used: [String],   // *** NEW: ["sentiment", "technical"]

  // Provenance & Testing
  test_mode: Boolean,          // *** NEW
  bot_version: String,

  // Context
  reason: String,
  balance_before: Decimal128,  // *** NEW
  balance_after: Decimal128,   // *** NEW

  created_at: ISODate,

  indexes: [
    { timestamp: -1 },
    { symbol: 1, timestamp: -1 },
    { signal_id: 1 },
    { test_mode: 1 }
  ]
}
```

#### 3. `holdings`
**Purpose:** Current positions (point-in-time snapshots)

```javascript
{
  _id: ObjectId,
  timestamp: ISODate,
  symbol: String,
  amount: Decimal128,
  avg_buy_price: Decimal128,
  current_price: Decimal128,
  unrealized_pnl: Decimal128,

  // Attribution
  entry_signal_id: ObjectId,   // *** NEW: Signal that started this position
  entry_trade_id: ObjectId,    // *** NEW: Trade that opened position

  test_mode: Boolean,

  indexes: [
    { symbol: 1 },
    { timestamp: -1 }
  ]
}
```

#### 4. `strategy_performance`
**Purpose:** Aggregated performance metrics by strategy

```javascript
{
  _id: ObjectId,
  strategy_name: String,       // "sentiment", "technical", "volume"
  period_start: ISODate,
  period_end: ISODate,

  // Signal metrics
  signals_generated: Int,
  signals_executed: Int,
  execution_rate: Decimal128,

  // Trade metrics
  total_trades: Int,
  winning_trades: Int,
  losing_trades: Int,
  win_rate: Decimal128,

  // Financial metrics
  total_pnl: Decimal128,
  avg_pnl_per_trade: Decimal128,
  max_drawdown: Decimal128,

  // Configuration snapshot
  strategy_config: Object,     // Config at this time

  test_mode: Boolean,
  calculated_at: ISODate,

  indexes: [
    { strategy_name: 1, period_start: -1 },
    { test_mode: 1 }
  ]
}
```

#### 5. `strategy_definitions`
**Purpose:** Dynamic strategy configurations

```javascript
{
  _id: ObjectId,
  name: String,                // "sentiment", "custom_rsi"
  version: String,             // "1.0.0"

  // Configuration
  enabled: Boolean,
  weight: Decimal128,
  parameters: Object,          // Strategy-specific params

  // Code reference
  class_name: String,          // "SentimentStrategy"
  module_path: String,         // "app.strategies.sentiment"

  // Metadata
  created_at: ISODate,
  updated_at: ISODate,
  created_by: String,          // "user" or "system"

  // Validation
  min_confidence: Decimal128,
  max_position_size: Decimal128,

  // A/B Testing
  ab_test_group: String,       // "A", "B", "control"

  indexes: [
    { name: 1, version: -1 },
    { enabled: 1 }
  ]
}
```

#### 6. `errors`
**Purpose:** Structured error logging

```javascript
{
  _id: ObjectId,
  timestamp: ISODate,
  level: String,               // "ERROR", "WARNING", "CRITICAL"
  component: String,           // "paper_trader", "strategy_manager"
  error_type: String,          // "API_ERROR", "VALIDATION_ERROR"
  message: String,

  // Context
  stack_trace: String,
  context: Object,             // Additional debug info
  symbol: String,              // If trade-related

  // Resolution
  resolved: Boolean,
  resolved_at: ISODate,
  resolution_notes: String,

  test_mode: Boolean,

  indexes: [
    { timestamp: -1 },
    { level: 1, resolved: 1 },
    { component: 1 }
  ]
}
```

#### 7. `rss_feeds`
**Purpose:** News feed configurations

```javascript
{
  _id: ObjectId,
  url: String,
  name: String,
  enabled: Boolean,
  keywords: [String],

  // Stats
  last_fetched: ISODate,
  total_items_fetched: Int,
  error_count: Int,

  created_at: ISODate,
  updated_at: ISODate,

  indexes: [
    { enabled: 1 },
    { url: 1 }
  ]
}
```

#### 8. `seen_news`
**Purpose:** Deduplication tracking for news

```javascript
{
  _id: ObjectId,
  headline: String,
  url: String,
  feed_id: ObjectId,           // Reference to rss_feeds
  seen_at: ISODate,

  // Sentiment analysis result
  sentiment_score: Decimal128,
  keywords_matched: [String],
  triggered_signal: Boolean,
  signal_id: ObjectId,         // If it triggered a signal

  indexes: [
    { url: 1 },                // Unique constraint
    { headline: 1 },
    { seen_at: -1 }
  ]
}
```

---

## Key Schema Features

### 1. Test Mode Isolation
Every collection has `test_mode: Boolean`
- Queries can easily filter: `db.signals.find({ test_mode: false })`
- Clean separation of test and production data
- Can run parallel test strategies without contamination

### 2. Data Provenance
- `bot_version`: Track which code version generated the data
- `strategy_version`: Hash of strategy configs
- `created_at`: Exact timestamp
- Signal → Trade → Performance linkage via IDs

### 3. Strategy Attribution
- `signal_id` in trades links back to originating signal
- `strategies_used` array shows which strategies contributed
- Can calculate per-strategy win rates and P&L

### 4. Dynamic Strategy Framework
- `strategy_definitions` collection allows runtime config
- Can enable/disable strategies via API
- A/B testing support
- Version tracking

### 5. Performance Analytics
- Pre-aggregated `strategy_performance` for fast dashboards
- Can rebuild from raw signal/trade data if needed
- Time-series analysis ready

---

## Migration Strategy

### Phase 1: Dual-Write Mode (Safety First)
```
1. Keep existing JSON files
2. Add MongoDB writes
3. Reads still from files
4. Validate data consistency
```

### Phase 2: Dual-Read Validation
```
1. Read from both sources
2. Compare results
3. Log discrepancies
4. Fix any issues
```

### Phase 3: MongoDB Primary
```
1. Switch reads to MongoDB
2. Keep writing to files as backup
3. Monitor for 24 hours
```

### Phase 4: Complete Migration
```
1. Stop writing to files
2. MongoDB is single source of truth
3. Archive old files
```

---

## Implementation Plan

### Step 1: Install Dependencies
```bash
pip install pymongo motor  # motor = async MongoDB for FastAPI
pip install dnspython       # For MongoDB+srv connections
```

### Step 2: Create Database Connection Layer
File: `src/app/database/mongodb.py`
- Connection management
- Connection pooling
- Retry logic
- Health checks

### Step 3: Create Data Models
File: `src/app/database/models.py`
- Pydantic models for each collection
- Validation logic
- Type safety

### Step 4: Create Repository Pattern
Files: `src/app/database/repositories/*.py`
- `SignalRepository`
- `TradeRepository`
- `HoldingRepository`
etc.

### Step 5: Update Application Code
- Modify `strategy_signal_logger.py` to write to MongoDB
- Modify `paper_trader.py` to write trades to MongoDB
- Update dashboard endpoints to read from MongoDB

### Step 6: Create Migration Script
File: `scripts/migrate_to_mongodb.py`
- Load JSON files
- Clean test data
- Validate and transform
- Insert into MongoDB
- Generate report

### Step 7: Create Rollback Plan
File: `scripts/rollback_from_mongodb.py`
- Export from MongoDB back to JSON
- Just in case!

---

## Testing Strategy

### Unit Tests
- Test each repository method
- Mock MongoDB connections
- Validate data transformations

### Integration Tests
- Test full write → read cycle
- Test queries and aggregations
- Test concurrent access

### Data Validation Tests
- Compare file vs MongoDB results
- Verify no data loss
- Check foreign key integrity

---

## Rollback Plan

If anything goes wrong:
1. Stop bot
2. Restore from `backups/pre_mongodb_*`
3. Revert code changes
4. Restart bot

All data is backed up at: `backups/pre_mongodb_20251025_140028/`

---

## Success Metrics

Migration is successful when:
- ✅ 100% of valid trades migrated
- ✅ 100% of recent signals (Oct 24-25) migrated
- ✅ Test data clearly marked with `test_mode: true`
- ✅ Signal → Trade correlation shows >0% execution rate
- ✅ Dashboard loads without errors
- ✅ Performance tab shows accurate data
- ✅ Can add new strategy via API
- ✅ Can query historical data efficiently

---

## Next Steps

**Choose MongoDB option:**
1. MongoDB Atlas (cloud, free tier) - **Recommended for quick start**
2. Local MongoDB installation - **Recommended for production**
3. TinyDB (development only) - **Not recommended for production**

Once you choose, I'll:
1. Set up the connection
2. Create all the models and repositories
3. Build the migration script
4. Migrate your data
5. Update the application code
6. Validate everything works

**Which option do you prefer?**
